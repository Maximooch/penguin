# Penguin API – Hardening & Roll-out Plan

> Last updated: {{DATE}}

This document enumerates the concrete tasks required to take the current Penguin HTTP/WebSocket API from **"works-on-my-machine"** to **production-ready**.

---

## 1. Endpoint Inventory & Contract Freeze (📋 Week 1)

1. Catalogue every route in `penguin/penguin/api/routes.py`.
2. Confirm JSON request/response shapes against docs in `docs/api_reference/*`.
3. Flag **breaking** vs **additive** changes.
4. Freeze API contract (v1) and tag commit `api-contract-v1`.

---

## 2. Core / Engine Integration (⚙️ Week 1-2)

Task | Owner | Notes
---|---|---
Wire `PenguinCore.engine` into every synchronous endpoint | `@backend` | Prefer Engine over legacy RunMode for determinism.
Unify streaming implementation (Core vs Engine) | `@backend` | Single code-path => simpler back-pressure handling.
Expose Engine resource stats (`tokens`, `wall_clock`) on `/system/status` | `@backend` | Enables dashboards.

---

## 3. Checkpoint & Branch API (🌳 Week 2)

- [ ] Finish `ConversationManager` implementations for:
  - `create_manual_checkpoint()`
  - `rollback_to_checkpoint()`
  - `branch_from_checkpoint()`
- [ ] Persist checkpoints in **workspace/{session_id}/checkpoints/**.
- [ ] Add integration tests covering full workflow.

---

## 4. Model Management (🤖 Week 2-3)

1. Validate `load_model()` against all providers in `config.yml`.
2. Prevent config write when running from a read-only pip install; fallback to `$XDG_CONFIG_HOME/penguin/`.
3. Emit **model-switched** EventBus event and ensure frontend refreshes its capabilities cache.

---

## 5. Stability & Observability (📈 Week 3)

- Structured logging (`logfmt`) for API layer.
- Add Prometheus metrics exporter (request latency, HTTP codes, token usage).
- Healthcheck route `/api/v1/system/health` for k8s/LB probes.

---

## 6. Test Suite Expansion (🧪 Week 3-4)

Coverage Target | Current | Goal
---|---|---
Unit tests (api layer) | ~25 % | 80 %
Integration (end-to-end) | n/a | 10 happy-path + 10 error-path cases

Key new tests:
- WebSocket chat stream happy path with mocked LiteLLM provider.
- Checkpoint CRUD + branch round-trip.
- Model switch during active session.

---

## 7. Security Pass (🔒 Week 4)

1. **Input validation** – run `pydantic` `.validate()` on all incoming JSON.
2. Limit uploaded file types & size (image upload endpoint).
3. API key / JWT auth middleware placeholder (behind feature flag until auth subsystem lands).
4. Automated dependency scanning (GitHub Dependabot or Renovate).

---

## 8. Documentation & SDK Generation (📚 Week 4)

- Ensure `OpenAPI` autogenerated docs (`/api/docs`) match frozen contract.
- Publish markdown quick-start examples for:
  - Chat message
  - Streaming conversation
  - Synchronous task execution with Engine
  - Checkpoint lifecycle
- Regenerate TypeScript & Python client SDKs via `openapi-generator`.

---

## 9. Deployment Checklist (🚀 Week 5)

- `uvicorn` production settings (workers, keepalive, timeouts).
- Dockerfile multi-stage build (slim runtime image).
- Helm chart / Terraform module for cloud deploy.
- Canary environment (`api-dev.penguin.ai`) + smoke tests.

---

## 10. Rollout & Versioning (📦)

Step | Description
---|---
`v0.1.0` beta | Internal dog-food; contract may change.
`v1.0.0-rc1` | Contract frozen; start collecting feedback.
`v1.0.0` GA | Public release; semantic-versioning guarantees begin.

---

## 11. Nice-to-Have Backlog

- Rate-limiting middleware (per IP & per API key).
- SSE fallback for browsers that block websockets.
- Delta-stream patching for bandwidth optimisation.
- **gRPC** mirror of critical endpoints for low-latency mobile clients.

---

### Timeline Snapshot

```mermaid
gantt
title Penguin API delivery timeline
sections
Week 1: Contract & Core  :a1, 2024-07-01, 7d
Week 2: Checkpoints      :a2, after a1, 7d
Week 3: Observability    :a3, after a2, 7d
Week 4: Tests & Security :a4, after a3, 7d
Week 5: Deploy & Docs    :a5, after a4, 7d
```

---

## 12. Acceptance Criteria

- ☑️ All endpoints covered by unit + integration tests.
- ☑️ Latency P95 < 250 ms for /chat/message under 100 rps on M-series host.
- ☑️ Frontend consumes new API without local patches.
- ☑️ Docker image publishes SBOM and passes Trivy scan.
- ☑️ One-click rollback via checkpoint API demoed.

---

End of document. 